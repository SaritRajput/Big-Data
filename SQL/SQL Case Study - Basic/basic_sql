 --Use postgrSQl and pgadmin tool--
 
 Data Prepration  and Understanding
1)what is total number of rows in each table?

select count(*) from customer
select count(*) from TRANSACTIONS
select count(*) from prod_cat_info

2)what is total number of transaction?
select count(*) from transactions

3) change coumn in date format
update customer set dob=to_date(dob,'dd/mm/yyyy') where dob=dob

alter table customer alter column dob type date
using dob::date

update transactions set tran_date=to_date(tran_date,'dd/mm.yyyy') where tran_date=tran_date
alter table transactions alter column tran_date type date using tran_date::date
4)select min(dob),max(dob) from customer
select customer_id,dob,gender,city_code,
extract(day from dob) as day,extract(month from dob)as month,extract(year from dob)as year  from customer
5)select * from prod_cat_info where prod_subcat='DIY'

DATA ANALYSIS

1)select store_type, max(tran_date) from transactions group by store_type order by store_type desc
2)select count(gender) from customer where gender='M' 
select count(gender) from customer where gender='F' 

3)select city_code,max(customer_id) from customer group by city_code order by city_code desc
4)select prod_cat,prod_subcat from prod_cat_info where prod_cat='Books'

5)select pc.prod_cat,max(t.qty) as qty from transactions t
join prod_cat_info pc on t.prod_cat_code=pc.prod_cat_code
group by pc.prod_cat
6) select pd.prod_cat,sum(total_amt) as revenew from transactions t
join prod_cat_info pd on t.prod_cat_code=pd.prod_cat_code
where prod_cat in('Electronics','Books')
group by pd.prod_cat

7) How many customers have >10 transactions with us, excluding returns?
select customer_id,count(transaction_id) from customer c
join transactions t on c.customer_id=t.cust_id
where total_amt <0
group by customer_id having count(transaction_id)>10

8)What is the combined revenue earned from the “Electronics” & “Clothing”
	categories, from “Flagship stores”?
select t.store_type,pd.prod_cat,sum(total_amt) as Revenew from transactions t
join prod_cat_info pd on t.prod_cat_code=pd.prod_cat_code
where t.store_type='Flagship store' and pd.prod_cat in('Electronics','Clothing')
group by  t.store_type,pd.prod_cat

9)	What is the total revenue generated from “Male” customers 
	in “Electronics” category? Output should display total revenue by 
	prod sub-cat.

select pd.prod_subcat,sum(total_amt) as Revenew from transactions t
join customer c on t.cust_id=c.customer_id
join prod_cat_info pd on t.prod_cat_code=pd.prod_cat_code
where  pd.prod_cat in('Electronics') and c.gender='M'
group by  pd.prod_subcat

10)	What is percentage of sales and returns by product sub category; 
    display only top 5 sub categories in terms of sales?

	select    prod_subcat, sum((total_amt/sum_total_amt*100))::numeric(11,2) as sale_return from 
(
select pd.prod_subcat,ts.total_amt,sum(ts.total_amt) as sum_total_amt 
from transactions ts
 join prod_cat_info pd on  ts.prod_subcat_code=pd.prod_sub_cat_code
 
 group by pd.prod_subcat,ts.total_amt
	)a
group by a.prod_subcat


11)	For all customers aged between 25 to 35 years find what is the 
	net total revenue generated by these consumers in last 30 days of transactions
	from max transaction date available in the data?

select cust_id,sum(total_amt) as net_revenue from
(
 SELECT cust_id,(extract(year from current_date)-extract(year from dob)) cust_year,total_amt from customer c
 join transactions t on c.customer_id=t.cust_id
  where 
tran_date  between (select  max(tran_date) - INTERVAL '30 days' FROM transactions) and tran_date
) a
where a.cust_year between 25 and 35
group by a.cust_id

12)	Which product category has seen the max value of returns in the last 3 
	months of transactions?

select prod_cat,extract(month from tran_date) as month,sum(total_amt) as Revenue FROM transactions
join prod_cat_info  using(prod_cat_code)
where total_amt<0  and 

tran_date  between (select  max(tran_date) - INTERVAL '3 months' FROM transactions) and tran_date
group by prod_cat,tran_date order by month asc

select pd.prod_cat,extract(month from tran_date) as month,sum(total_amt) as Revenue FROM transactions ts
join prod_cat_info pd on ts.prod_cat_code=pd.prod_cat_code
where ts.total_amt<0  and 

tran_date  between (select  max(tran_date) - INTERVAL '3 months' FROM transactions) and tran_date
group by prod_cat,tran_date order by month asc

13)	Which store-type sells the maximum products; by value of sales amount and
	by quantity sold?

select store_type,sum(qty) as qty,sum(total_amt) as sale_amt from transactions

group by store_type
having sum(qty) >= all(select sum(qty) from transactions GROUP BY store_type)
and  sum(total_amt) >= all(select sum(total_amt) from transactions GROUP BY store_type)


14)	What are the categories for which average revenue is above the overall average.
	select pd.prod_cat,avg(total_amt)::numeric(11,2) average  from transactions ts
join prod_cat_info pd on ts.prod_cat_code=pd.prod_cat_code
where ts.total_amt>( select avg(total_amt) from transactions)
group by pd.prod_cat

15)	Find the average and total revenue by each subcategory for the categories 
	which are among top 5 categories in terms of quantity sold.

 select pd.prod_cat,pd.prod_subcat,avg(ts.total_amt)::numeric(11,2) as average,sum(ts.total_amt)::numeric(11,2) as revenue 
 from transactions ts
 join prod_cat_info pd on ts.prod_cat_code=pd.prod_cat_code and  ts.prod_subcat_code=pd.prod_sub_cat_code
 where pd.prod_cat in(
 select pd.prod_cat from transactions ts
 join prod_cat_info pd on ts.prod_cat_code=pd.prod_cat_code and  ts.prod_subcat_code=pd.prod_sub_cat_code
 group by pd.prod_cat order by  sum(qty) desc limit 5
 )
 
group by pd.prod_cat,pd.prod_subcat order by pd.prod_cat,pd.prod_subcat desc 
